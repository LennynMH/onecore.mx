# =====================================================
# Docker Compose - Production Environment
# =====================================================
# Uso: docker-compose -f docker-compose.production.yml up -d
# Nota: El archivo .env.production se carga automáticamente via env_file
# ⚠️ IMPORTANTE: Configura todas las variables de entorno antes de usar

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: onecore_sqlserver_prod
    env_file:
      - FastAPI/.env.production
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: ${SQL_SERVER_PASSWORD}
      MSSQL_PID: "Developer"  # Cambiar a Standard/Enterprise en producción real
    ports:
      - "${SQL_SERVER_PORT:-1433}:1433"
    volumes:
      - sqlserver_data_prod:/var/opt/mssql
      - ./BaseDatos/sqlserver/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${SQL_SERVER_PASSWORD} -C -Q 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: always
    networks:
      - onecore_network_prod

  api:
    build:
      context: ./FastAPI
      dockerfile: Dockerfile
    container_name: onecore_api_prod
    env_file:
      - FastAPI/.env.production
    environment:
      # Sobrescribir solo SQL_SERVER_HOST para Docker (nombre del servicio)
      # El resto de variables se cargan desde .env.production
      SQL_SERVER_HOST: sqlserver
    ports:
      - "8000:8000"
    depends_on:
      sqlserver:
        condition: service_healthy
    restart: always
    networks:
      - onecore_network_prod
    command: python main.py

volumes:
  sqlserver_data_prod:
    driver: local

networks:
  onecore_network_prod:
    driver: bridge

