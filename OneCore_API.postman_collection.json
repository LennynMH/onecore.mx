{
	"info": {
		"_postman_id": "onecore-api-collection",
		"name": "OneCore API - Evaluaci√≥n T√©cnica",
		"description": "Colecci√≥n completa de APIs para OneCore seg√∫n EVALUACION_TECNICA.txt, EVALUACION_TECNICA_V2.txt y EVALUACION_TECNICA_V3.txt\n\n**PARTE 1: APIs (EVALUACION_TECNICA.txt)**\n\n1. ‚úÖ API de Inicio de Sesi√≥n (Session Login API)\n   - Endpoint para usuarios an√≥nimos\n   - JWT firmado con id_usuario y rol\n   - Expiraci√≥n de 15 minutos\n   - Soporte para m√∫ltiples roles (admin, gestor)\n\n2. ‚úÖ API de Carga y Validaci√≥n de Archivos (File Upload and Validation API)\n   - Subida a AWS S3\n   - Almacenamiento en SQL Server\n   - Validaci√≥n (valores vac√≠os, tipos incorrectos, duplicados)\n   - Control de acceso por rol con JWT (admin, gestor)\n   - Tracking de errores en tabla dedicada\n\n3. ‚úÖ API de Renovaci√≥n de Token (Token Renewal API)\n   - Renueva JWT con tiempo adicional (30 minutos)\n   - Solo si el token original no ha expirado\n   - Validaci√≥n estricta de expiraci√≥n\n\n**PARTE 2: M√≥dulos Web (EVALUACION_TECNICA_V2.txt)**\n\n4. ‚úÖ API de Documentos (FASE 1-3 COMPLETA)\n   - POST /api/v1/documents/upload - Subir documentos (PDF, JPG, PNG)\n   - GET /api/v1/documents - Listar documentos con filtros\n   - GET /api/v1/documents/{id} - Obtener documento por ID\n   - ‚úÖ FASE 2: Clasificaci√≥n autom√°tica (FACTURA/INFORMACI√ìN) con AWS Textract\n     * Sistema de keywords con pesos para precisi√≥n\n     * Normalizaci√≥n de texto para mejor matching\n   - ‚úÖ FASE 3: Extracci√≥n de datos estructurados\n     * Facturas: Cliente, Proveedor, N√∫mero de Factura, Productos, Totales\n     * Informaci√≥n: Descripci√≥n, Resumen, An√°lisis de Sentimiento (OpenAI)\n     * Integraci√≥n con AWS Textract (FORMS y TABLES) y OpenAI\n\n5. ‚úÖ API de Historial (FASE 4 COMPLETA)\n   - GET /api/v1/history - Listar eventos con filtros avanzados\n     * Filtros: tipo, documento, usuario, clasificaci√≥n, fechas, descripci√≥n\n     * Paginaci√≥n configurable (default: 50 items)\n   - GET /api/v1/history/export - Exportar historial a Excel\n     * Exportaci√≥n a .xlsx con opci√≥n de incluir/excluir detalles\n     * Aplicaci√≥n de filtros al exportar\n\n**PARTE 3: USO DE IA Y REFACTORIZACI√ìN (EVALUACION_TECNICA_V3.txt)**\n\n6. ‚úÖ Refactorizaci√≥n Din√°mica (3.1)\n   - Arquitectura modular con controllers y routers\n   - Clases helper para operaciones comunes (DatabaseHelper, FileUtils, etc.)\n   - Separaci√≥n de responsabilidades mejorada\n\n7. ‚úÖ Documentaci√≥n Generada con IA (3.2)\n   - Documentaci√≥n completa de todas las funciones\n   - Descripci√≥n de qu√© hace, par√°metros y retorno\n\n8. ‚úÖ Pruebas Unitarias (3.3)\n   - 70 pruebas unitarias con Pytest\n   - 10+ casos de prueba por m√©todo\n   - Cobertura completa de casos de uso principales",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "onecore-api"
	},
	"item": [
		{
			"name": "Health & Info",
			"item": [
				{
					"name": "Health Check",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/health",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"health"
							]
						},
						"description": "Verifica el estado de la aplicaci√≥n"
					},
					"response": []
				},
				{
					"name": "Root Endpoint",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/",
							"host": [
								"{{base_url}}"
							],
							"path": [
								""
							]
						},
						"description": "Informaci√≥n general de la API"
					},
					"response": []
				}
			],
			"description": "Endpoints p√∫blicos sin autenticaci√≥n"
		},
		{
			"name": "1. API de Inicio de Sesi√≥n",
					"item": [
						{
							"name": "Login - Sin rol (default gestor)",
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 200) {",
											"    var jsonData = pm.response.json();",
											"    pm.environment.set(\"access_token\", jsonData.access_token);",
									"    pm.environment.set(\"user_id\", jsonData.user.id_usuario);",
									"    pm.environment.set(\"user_rol\", jsonData.user.rol);",
									"    console.log(\"‚úÖ Token guardado en variable de entorno\");",
									"    console.log(\"Usuario ID: \" + jsonData.user.id_usuario);",
									"    console.log(\"Rol: \" + jsonData.user.rol);",
									"    console.log(\"Expira en: \" + jsonData.expires_in + \" segundos\");",
									"    ",
									"    // Validar estructura del JWT",
									"    pm.test(\"Token contiene id_usuario\", function() {",
									"        pm.expect(jsonData.user).to.have.property(\"id_usuario\");",
									"    });",
									"    ",
									"    pm.test(\"Token contiene rol\", function() {",
									"        pm.expect(jsonData.user).to.have.property(\"rol\");",
									"    });",
									"    ",
									"    pm.test(\"Token type es bearer\", function() {",
									"        pm.expect(jsonData.token_type).to.eql(\"bearer\");",
									"    });",
									"    ",
									"    pm.test(\"Expiraci√≥n es 15 minutos (900 segundos)\", function() {",
									"        pm.expect(jsonData.expires_in).to.eql(900);",
									"    });",
											"}"
										],
										"type": "text/javascript"
									}
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{}",
									"options": {
										"raw": {
											"language": "json"
										}
									}
								},
								"url": {
									"raw": "{{base_url}}/api/v1/auth/login",
									"host": [
										"{{base_url}}"
									],
									"path": [
										"api",
										"v1",
										"auth",
										"login"
									]
								},
						"description": "**REQUISITO 1: API DE INICIO DE SESI√ìN**\n\nEndpoint que permite a usuarios an√≥nimos iniciar sesi√≥n.\n\n**Caracter√≠sticas:**\n- ‚úÖ Devuelve JWT firmado\n- ‚úÖ JWT contiene: `id_usuario` (user_id)\n- ‚úÖ JWT contiene: `rol` (role)\n- ‚úÖ Tiempo de expiraci√≥n: **15 minutos** (900 segundos)\n\n**Body opcional:**\n- Puede enviarse `{}` o `null`\n- Si no se especifica rol, por defecto es `\"gestor\"`\n\n**Respuesta:**\n```json\n{\n    \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n    \"token_type\": \"bearer\",\n    \"expires_in\": 900,\n    \"user\": {\n        \"id_usuario\": 1,\n        \"rol\": \"gestor\"\n    }\n}\n```\n\n**Nota:** El token se guarda autom√°ticamente en la variable de entorno `access_token`"
							},
							"response": []
						},
						{
							"name": "Login - Con rol admin",
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 200) {",
											"    var jsonData = pm.response.json();",
											"    pm.environment.set(\"access_token\", jsonData.access_token);",
									"    pm.environment.set(\"user_id\", jsonData.user.id_usuario);",
									"    pm.environment.set(\"user_rol\", jsonData.user.rol);",
									"    console.log(\"‚úÖ Token guardado (rol admin)\");",
									"    ",
									"    pm.test(\"Rol es admin\", function() {",
									"        pm.expect(jsonData.user.rol).to.eql(\"admin\");",
									"    });",
											"}"
										],
										"type": "text/javascript"
									}
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n    \"rol\": \"admin\"\n}",
									"options": {
										"raw": {
											"language": "json"
										}
									}
								},
								"url": {
									"raw": "{{base_url}}/api/v1/auth/login",
									"host": [
										"{{base_url}}"
									],
									"path": [
										"api",
										"v1",
										"auth",
										"login"
									]
								},
						"description": "Login con rol **admin**.\n\n**Importante:** El rol `admin` es necesario para acceder al endpoint de carga de archivos CSV."
							},
							"response": []
						},
						{
							"name": "Login - Con rol gestor",
							"event": [
								{
									"listen": "test",
									"script": {
										"exec": [
											"if (pm.response.code === 200) {",
											"    var jsonData = pm.response.json();",
											"    pm.environment.set(\"access_token\", jsonData.access_token);",
									"    pm.environment.set(\"user_id\", jsonData.user.id_usuario);",
									"    pm.environment.set(\"user_rol\", jsonData.user.rol);",
									"    console.log(\"‚úÖ Token guardado (rol gestor)\");",
											"}"
										],
										"type": "text/javascript"
									}
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Content-Type",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n    \"rol\": \"gestor\"\n}",
									"options": {
										"raw": {
											"language": "json"
										}
									}
								},
								"url": {
									"raw": "{{base_url}}/api/v1/auth/login",
									"host": [
										"{{base_url}}"
									],
									"path": [
										"api",
										"v1",
										"auth",
										"login"
									]
								},
						"description": "Login con rol **gestor** (expl√≠cito).\n\nEquivalente a no enviar el par√°metro rol."
					},
					"response": []
				}
			],
			"description": "**REQUISITO 1: API DE INICIO DE SESI√ìN (Session Login API)**\n\nImplementa un endpoint que permita a usuarios an√≥nimos iniciar sesi√≥n.\n\n**Requisitos cumplidos:**\n- ‚úÖ Endpoint para usuarios an√≥nimos\n- ‚úÖ Devuelve JWT firmado\n- ‚úÖ JWT contiene: `id_usuario` (user_id)\n- ‚úÖ JWT contiene: `rol` (role)\n- ‚úÖ Tiempo de expiraci√≥n de **15 minutos**"
		},
		{
			"name": "2. API de Carga y Validaci√≥n de Archivos",
			"item": [
				{
					"name": "Upload CSV File",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    ",
									"    pm.test(\"Upload exitoso\", function() {",
									"        pm.expect(jsonData.success).to.be.true;",
									"    });",
									"    ",
									"    pm.test(\"Contiene filename (con timestamp)\", function() {",
									"        pm.expect(jsonData).to.have.property(\"filename\");",
									"        // El filename debe incluir timestamp para evitar duplicados",
									"    });",
									"    ",
									"    pm.test(\"Contiene original_filename\", function() {",
									"        pm.expect(jsonData).to.have.property(\"original_filename\");",
									"    });",
									"    ",
									"    pm.test(\"Contiene rows_processed\", function() {",
									"        pm.expect(jsonData).to.have.property(\"rows_processed\");",
									"    });",
									"    ",
									"    pm.test(\"Contiene validation_errors\", function() {",
									"        pm.expect(jsonData).to.have.property(\"validation_errors\");",
									"        pm.expect(jsonData.validation_errors).to.be.an(\"array\");",
									"    });",
									"    ",
									"    pm.test(\"Contiene param1 y param2\", function() {",
									"        pm.expect(jsonData).to.have.property(\"param1\");",
									"        pm.expect(jsonData).to.have.property(\"param2\");",
									"    });",
									"    ",
									"    if (jsonData.validation_errors.length > 0) {",
									"        console.log(\"‚ö†Ô∏è Errores de validaci√≥n encontrados:\");",
									"        jsonData.validation_errors.forEach(function(error) {",
									"            console.log(\"  - \" + error.type + \": \" + error.message);",
									"        });",
									"    } else {",
									"        console.log(\"‚úÖ Archivo validado sin errores\");",
									"    }",
									"    ",
									"    if (jsonData.s3_key) {",
									"        console.log(\"‚úÖ Archivo subido a S3: \" + jsonData.s3_key);",
									"    } else {",
									"        console.log(\"‚ö†Ô∏è S3 no configurado, archivo guardado solo en BD\");",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text",
								"description": "JWT token obtenido del endpoint de login"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "file",
									"type": "file",
									"src": [],
									"description": "Archivo CSV a subir. Debe ser formato CSV v√°lido."
								},
								{
									"key": "param1",
									"value": "value1",
									"type": "text",
									"description": "Primer par√°metro adicional (obligatorio)"
								},
								{
									"key": "param2",
									"value": "value2",
									"type": "text",
									"description": "Segundo par√°metro adicional (obligatorio)"
								}
							]
						},
						"url": {
							"raw": "{{base_url}}/api/v1/files/upload",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"files",
								"upload"
							]
						},
						"description": "**REQUISITO 2: API DE CARGA Y VALIDACI√ìN DE ARCHIVOS**\n\nEndpoint para subir un archivo CSV junto con dos par√°metros adicionales.\n\n**REQUISITOS DEL ENDPOINT:**\n\n**a) Subida a AWS S3:** ‚úÖ\n- El archivo se almacena en un bucket configurado\n- Ruta: `uploads/YYYY/MM/DD/filename_timestamp.csv`\n- **Nombres √∫nicos:** Se agrega timestamp `_ddmmyyyyhhmmss` al nombre para evitar duplicados\n- Si S3 no est√° configurado, el archivo se guarda solo en la base de datos\n\n**b) Almacenamiento en SQL Server:** ‚úÖ\n- El contenido del archivo se procesa y guarda en la base de datos\n- Metadatos en tabla `file_uploads` (incluye `has_errors` y `error_count`)\n- Datos de cada fila en tabla `file_data` (como JSON)\n- Errores de validaci√≥n en tabla `file_validation_errors`\n\n**c) Validaci√≥n:** ‚úÖ\n- Devuelve una lista con las validaciones aplicadas al archivo:\n  - **Valores vac√≠os:** Detecta campos vac√≠os en cualquier fila\n  - **Tipos incorrectos:** Valida formato de emails, n√∫meros, fechas\n  - **Duplicados:** Detecta filas duplicadas\n- Los errores se guardan en BD para consulta posterior\n\n**d) Control de acceso:** ‚úÖ\n- El acceso est√° limitado a usuarios con rol espec√≠fico (por defecto: `admin`)\n- Valida el token JWT en el header `Authorization`\n- Si el usuario no tiene el rol requerido, retorna 403 Forbidden\n\n**Ejemplo de respuesta exitosa:**\n```json\n{\n    \"success\": true,\n    \"message\": \"File uploaded successfully to S3 and database\",\n    \"filename\": \"data_18122025201153.csv\",\n    \"original_filename\": \"data.csv\",\n    \"s3_key\": \"uploads/2025/12/18/data_18122025201153.csv\",\n    \"s3_bucket\": \"onecore-uploads-dev\",\n    \"rows_processed\": 100,\n    \"validation_errors\": [],\n    \"param1\": \"value1\",\n    \"param2\": \"value2\"\n}\n```\n\n**Ejemplo de respuesta con errores de validaci√≥n:**\n```json\n{\n    \"success\": true,\n    \"message\": \"File uploaded successfully to S3 and database\",\n    \"filename\": \"data_18122025201153.csv\",\n    \"original_filename\": \"data.csv\",\n    \"s3_key\": \"uploads/2025/12/18/data_18122025201153.csv\",\n    \"s3_bucket\": \"onecore-uploads-dev\",\n    \"rows_processed\": 95,\n    \"validation_errors\": [\n        {\n            \"type\": \"empty_value\",\n            \"field\": \"email\",\n            \"message\": \"Empty value in field 'email'\",\n            \"row\": 5\n        },\n        {\n            \"type\": \"incorrect_type\",\n            \"field\": \"age\",\n            \"message\": \"Invalid number format in field 'age': 'abc'\",\n            \"row\": 10\n        },\n        {\n            \"type\": \"duplicate\",\n            \"field\": null,\n            \"message\": \"Duplicate row detected. Row 15 is identical to row 8\",\n            \"row\": 15\n        }\n    ],\n    \"param1\": \"value1\",\n    \"param2\": \"value2\"\n}\n```\n\n**Mejoras implementadas:**\n- ‚úÖ **Nombres √∫nicos:** `filename` incluye timestamp para evitar duplicados\n- ‚úÖ **Tracking de errores:** Errores guardados en `file_validation_errors`\n- ‚úÖ **Metadatos mejorados:** `has_errors` y `error_count` en `file_uploads`\n- ‚úÖ **Nombre original:** `original_filename` preserva el nombre original del archivo\n\n**Nota:** Aseg√∫rate de hacer login con rol `admin` antes de usar este endpoint."
					},
					"response": []
				}
			],
			"description": "**REQUISITO 2: API DE CARGA Y VALIDACI√ìN DE ARCHIVOS (File Upload and Validation API)**\n\nEndpoint para subir un archivo CSV junto con dos par√°metros adicionales.\n\n**Requisitos cumplidos:**\n- ‚úÖ **a) Subida a AWS S3:** El archivo se almacena en un bucket configurado con nombres √∫nicos (timestamp)\n- ‚úÖ **b) Almacenamiento en SQL Server:** El contenido se procesa y guarda en la base de datos con tracking de errores\n- ‚úÖ **c) Validaci√≥n:** Devuelve lista con validaciones (valores vac√≠os, tipos incorrectos, duplicados)\n- ‚úÖ **d) Control de acceso:** Limitado a usuarios con rol espec√≠fico, validando el token JWT\n\n**Mejoras adicionales:**\n- ‚úÖ Nombres √∫nicos de archivos con timestamp (`_ddmmyyyyhhmmss`)\n- ‚úÖ Sistema de tracking de errores en BD (`file_validation_errors`)\n- ‚úÖ Campos `has_errors` y `error_count` en `file_uploads`"
		},
		{
			"name": "3. API de Renovaci√≥n de Token",
			"item": [
				{
					"name": "Renew Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    pm.environment.set(\"access_token\", jsonData.access_token);",
									"    console.log(\"‚úÖ Token renovado exitosamente\");",
									"    console.log(\"Nuevo tiempo de expiraci√≥n: \" + jsonData.expires_in + \" segundos\");",
									"    ",
									"    pm.test(\"Token renovado\", function() {",
									"        pm.expect(jsonData).to.have.property(\"access_token\");",
									"        pm.expect(jsonData.access_token).to.not.be.empty;",
									"    });",
									"    ",
									"    pm.test(\"Token type es bearer\", function() {",
									"        pm.expect(jsonData.token_type).to.eql(\"bearer\");",
									"    });",
									"    ",
									"    pm.test(\"Contiene informaci√≥n de usuario\", function() {",
									"        pm.expect(jsonData).to.have.property(\"user\");",
									"        pm.expect(jsonData.user).to.have.property(\"id_usuario\");",
									"        pm.expect(jsonData.user).to.have.property(\"rol\");",
									"    });",
									"} else if (pm.response.code === 401) {",
									"    console.log(\"‚ùå Error: Token expirado o inv√°lido\");",
									"    console.log(\"Debes hacer login nuevamente\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text",
								"description": "JWT token actual (debe estar vigente, no expirado)"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/auth/renew",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"renew"
							]
						},
						"description": "**REQUISITO 3: API DE RENOVACI√ìN DE TOKEN (Token Renewal API)**\n\nImplementa un endpoint para renovar el JWT, generando un nuevo token con un tiempo de expiraci√≥n adicional.\n\n**Requisitos cumplidos:**\n- ‚úÖ Endpoint para renovar el JWT\n- ‚úÖ Genera un nuevo token con tiempo de expiraci√≥n adicional (30 minutos por defecto)\n- ‚úÖ **Solo puede ser accedido si el token original a√∫n no ha expirado**\n\n**Funcionamiento:**\n1. Valida que el token en el header `Authorization` no haya expirado\n2. Si el token es v√°lido, genera un nuevo token con los mismos datos del usuario\n3. El nuevo token tiene un tiempo de expiraci√≥n adicional (30 minutos por defecto)\n4. Si el token original expir√≥, retorna error 401 Unauthorized\n\n**Ejemplo de respuesta exitosa:**\n```json\n{\n    \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n    \"token_type\": \"bearer\",\n    \"expires_in\": 1800,\n    \"user\": {\n        \"id_usuario\": 1,\n        \"rol\": \"admin\"\n    }\n}\n```\n\n**Ejemplo de error (token expirado):**\n```json\n{\n    \"detail\": \"Token has expired. Cannot renew expired token.\"\n}\n```\n\n**Nota:** El nuevo token se guarda autom√°ticamente en la variable de entorno `access_token`"
					},
					"response": []
				}
			],
			"description": "**REQUISITO 3: API DE RENOVACI√ìN DE TOKEN (Token Renewal API)**\n\nImplementa un endpoint para renovar el JWT, generando un nuevo token con un tiempo de expiraci√≥n adicional.\n\n**Requisitos cumplidos:**\n- ‚úÖ Endpoint para renovar el JWT\n- ‚úÖ Genera un nuevo token con tiempo de expiraci√≥n adicional\n- ‚úÖ Solo puede ser accedido si el token original a√∫n no ha expirado"
		},
		{
			"name": "4. API de Documentos (FASE 1)",
			"item": [
				{
					"name": "Upload Document",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    ",
									"    pm.test(\"Upload exitoso\", function() {",
									"        pm.expect(jsonData.success).to.be.true;",
									"    });",
									"    ",
									"    pm.test(\"Contiene document_id\", function() {",
									"        pm.expect(jsonData).to.have.property(\"document_id\");",
									"    });",
									"    ",
									"    pm.test(\"Contiene filename con timestamp\", function() {",
									"        pm.expect(jsonData).to.have.property(\"filename\");",
									"        // El filename debe incluir timestamp para evitar duplicados",
									"    });",
									"    ",
									"    pm.test(\"Contiene original_filename\", function() {",
									"        pm.expect(jsonData).to.have.property(\"original_filename\");",
									"    });",
									"    ",
									"    if (jsonData.document_id) {",
									"        pm.environment.set(\"last_document_id\", jsonData.document_id);",
									"        console.log(\"‚úÖ Document ID guardado: \" + jsonData.document_id);",
									"    }",
									"    ",
									"    if (jsonData.s3_key) {",
									"        console.log(\"‚úÖ Documento subido a S3: \" + jsonData.s3_key);",
									"    } else {",
									"        console.log(\"‚ö†Ô∏è S3 no configurado, documento guardado solo en BD\");",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text",
								"description": "JWT token obtenido del endpoint de login"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "file",
									"type": "file",
									"src": [],
									"description": "Archivo PDF, JPG o PNG a subir. Formatos permitidos: .pdf, .jpg, .jpeg, .png"
								}
							]
						},
						"url": {
							"raw": "{{base_url}}/api/v1/documents/upload",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"documents",
								"upload"
							]
						},
						"description": "**FASE 1-3: API DE CARGA DE DOCUMENTOS CON CLASIFICACI√ìN Y EXTRACCI√ìN AUTOM√ÅTICA**\n\nEndpoint para subir documentos en formato PDF, JPG o PNG con procesamiento completo.\n\n**Caracter√≠sticas FASE 1:**\n- ‚úÖ Valida formato (PDF, JPG, PNG)\n- ‚úÖ Genera nombre √∫nico con timestamp (`_ddmmyyyyhhmmss`)\n- ‚úÖ Sube a AWS S3 (si est√° configurado)\n- ‚úÖ Guarda metadatos en Base de Datos\n- ‚úÖ Registra evento de upload\n\n**Caracter√≠sticas FASE 2 (Clasificaci√≥n Autom√°tica):**\n- ‚úÖ Clasificaci√≥n autom√°tica con AWS Textract (FACTURA/INFORMACI√ìN)\n- ‚úÖ Sistema de keywords con pesos para precisi√≥n\n- ‚úÖ Normalizaci√≥n de texto para mejor matching\n- ‚úÖ Logging detallado para debugging\n\n**Caracter√≠sticas FASE 3 (Extracci√≥n de Datos):**\n- ‚úÖ **Para FACTURAS:** Extracci√≥n de Cliente, Proveedor, N√∫mero de Factura, Productos (cantidad, nombre, precio unitario, total), Totales\n- ‚úÖ **Para INFORMACI√ìN:** Extracci√≥n de Descripci√≥n, Resumen, An√°lisis de Sentimiento (OpenAI)\n- ‚úÖ Integraci√≥n con AWS Textract (FORMS y TABLES) para datos estructurados\n- ‚úÖ Integraci√≥n con OpenAI para an√°lisis de sentimiento\n- ‚úÖ Datos guardados en `document_extracted_data`\n\n**Ejemplo de respuesta exitosa (FACTURA):**\n```json\n{\n    \"success\": true,\n    \"message\": \"Document uploaded successfully to S3 and database\",\n    \"document_id\": 1,\n    \"filename\": \"invoice_18122025201153.pdf\",\n    \"original_filename\": \"invoice.pdf\",\n    \"s3_key\": \"documents/2025/12/18/invoice_18122025201153.pdf\",\n    \"s3_bucket\": \"onecore-uploads-dev\",\n    \"classification\": \"FACTURA\",\n    \"extracted_data\": {\n        \"cliente\": {\n            \"nombre\": \"Empresa ABC S.A. de C.V.\",\n            \"direccion\": \"Av. Principal 123\",\n            \"rfc\": \"ABC123456XYZ\"\n        },\n        \"proveedor\": {\n            \"nombre\": \"Servicios Tecnol√≥gicos XYZ\",\n            \"direccion\": \"Calle Tecnolog√≠a 456\"\n        },\n        \"numero_factura\": \"FAC-2025-001\",\n        \"productos\": [\n            {\n                \"cantidad\": 10,\n                \"nombre\": \"Producto A\",\n                \"precio_unitario\": 100.00,\n                \"total\": 1000.00\n            }\n        ],\n        \"subtotal\": 1000.00,\n        \"iva\": 160.00,\n        \"total\": 1160.00\n    },\n    \"processing_time_ms\": 2450\n}\n```\n\n**Ejemplo de respuesta exitosa (INFORMACI√ìN):**\n```json\n{\n    \"success\": true,\n    \"message\": \"Document uploaded successfully to S3 and database\",\n    \"document_id\": 2,\n    \"filename\": \"info_18122025201153.pdf\",\n    \"original_filename\": \"info.pdf\",\n    \"classification\": \"INFORMACI√ìN\",\n    \"extracted_data\": {\n        \"descripcion\": \"Documento informativo sobre...\",\n        \"resumen\": \"Resumen generado por OpenAI...\",\n        \"sentimiento\": \"positivo\"\n    },\n    \"processing_time_ms\": 3200\n}\n```\n\n**Nota:**\n- El `document_id` se guarda autom√°ticamente en la variable `last_document_id`\n- La clasificaci√≥n y extracci√≥n se realizan autom√°ticamente durante el upload\n- El tiempo de procesamiento incluye clasificaci√≥n y extracci√≥n"
					},
					"response": []
				},
				{
					"name": "List Documents",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    ",
									"    pm.test(\"Listado exitoso\", function() {",
									"        pm.expect(jsonData).to.have.property(\"total\");",
									"        pm.expect(jsonData).to.have.property(\"documents\");",
									"        pm.expect(jsonData.documents).to.be.an(\"array\");",
									"    });",
									"    ",
									"    pm.test(\"Contiene paginaci√≥n\", function() {",
									"        pm.expect(jsonData).to.have.property(\"page\");",
									"        pm.expect(jsonData).to.have.property(\"limit\");",
									"    });",
									"    ",
									"    console.log(\"‚úÖ Total de documentos: \" + jsonData.total);",
									"    console.log(\"üìÑ Documentos en esta p√°gina: \" + jsonData.documents.length);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text",
								"description": "JWT token obtenido del endpoint de login"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/documents?page=1&limit=20",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"documents"
							],
							"query": [
								{
									"key": "page",
									"value": "1",
									"description": "N√∫mero de p√°gina (default: 1)"
								},
								{
									"key": "limit",
									"value": "20",
									"description": "Items por p√°gina (default: 20, max: 100)"
								},
								{
									"key": "classification",
									"value": "",
									"description": "Filtrar por clasificaci√≥n (FACTURA, INFORMACI√ìN)",
									"disabled": true
								},
								{
									"key": "date_from",
									"value": "",
									"description": "Fecha desde (YYYY-MM-DD)",
									"disabled": true
								},
								{
									"key": "date_to",
									"value": "",
									"description": "Fecha hasta (YYYY-MM-DD)",
									"disabled": true
								}
							]
						},
						"description": "**FASE 1-3: API DE LISTADO DE DOCUMENTOS CON DATOS EXTRA√çDOS**\n\nEndpoint para listar documentos con filtros y paginaci√≥n, incluyendo datos extra√≠dos.\n\n**Filtros disponibles:**\n- `classification`: Filtrar por tipo (FACTURA, INFORMACI√ìN)\n- `date_from`: Fecha desde (YYYY-MM-DD)\n- `date_to`: Fecha hasta (YYYY-MM-DD)\n- `page`: N√∫mero de p√°gina (default: 1)\n- `limit`: Items por p√°gina (default: 20, max: 100)\n\n**Ejemplo de respuesta (con datos extra√≠dos):**\n```json\n{\n    \"total\": 50,\n    \"page\": 1,\n    \"limit\": 20,\n    \"documents\": [\n        {\n            \"id\": 1,\n            \"filename\": \"invoice_18122025201153.pdf\",\n            \"original_filename\": \"invoice.pdf\",\n            \"file_type\": \"PDF\",\n            \"classification\": \"FACTURA\",\n            \"uploaded_at\": \"2025-12-18T20:11:53\",\n            \"processed_at\": \"2025-12-18T20:11:55\",\n            \"extracted_data\": {\n                \"cliente\": {\"nombre\": \"...\", \"direccion\": \"...\"},\n                \"proveedor\": {\"nombre\": \"...\", \"direccion\": \"...\"},\n                \"numero_factura\": \"FAC-2025-001\",\n                \"productos\": [...],\n                \"total\": 1160.00\n            },\n            \"s3_key\": \"documents/2025/12/18/invoice_18122025201153.pdf\",\n            \"s3_bucket\": \"onecore-uploads-dev\",\n            \"file_size\": 245760\n        }\n    ]\n}\n```\n\n**Nota:**\n- Los documentos se ordenan por fecha de upload (m√°s recientes primero)\n- `extracted_data` contiene los datos estructurados extra√≠dos seg√∫n la clasificaci√≥n\n- Para FACTURAS: cliente, proveedor, productos, totales\n- Para INFORMACI√ìN: descripci√≥n, resumen, sentimiento"
					},
					"response": []
				},
				{
					"name": "Get Document by ID",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    ",
									"    pm.test(\"Documento obtenido\", function() {",
									"        pm.expect(jsonData).to.have.property(\"id\");",
									"        pm.expect(jsonData).to.have.property(\"filename\");",
									"        pm.expect(jsonData).to.have.property(\"file_type\");",
									"    });",
									"    ",
									"    pm.test(\"Contiene metadatos\", function() {",
									"        pm.expect(jsonData).to.have.property(\"uploaded_at\");",
									"    });",
									"    ",
									"    console.log(\"‚úÖ Documento ID: \" + jsonData.id);",
									"    console.log(\"üìÑ Archivo: \" + jsonData.original_filename);",
									"    if (jsonData.extracted_data) {",
									"        console.log(\"üìä Datos extra√≠dos disponibles\");",
									"    } else {",
									"        console.log(\"‚ö†Ô∏è Datos extra√≠dos a√∫n no disponibles (FASE 3)\");",
									"    }",
									"} else if (pm.response.code === 404) {",
									"    console.log(\"‚ùå Documento no encontrado\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text",
								"description": "JWT token obtenido del endpoint de login"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/documents/{{last_document_id}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"documents",
								"{{last_document_id}}"
							],
							"description": "Usa el ID del √∫ltimo documento subido. Tambi√©n puedes usar un ID espec√≠fico."
						},
						"description": "**FASE 1-3: API DE OBTENER DOCUMENTO POR ID CON DATOS EXTRA√çDOS**\n\nEndpoint para obtener un documento espec√≠fico por su ID, incluyendo todos los datos extra√≠dos.\n\n**Ejemplo de respuesta (FACTURA):**\n```json\n{\n    \"id\": 1,\n    \"filename\": \"invoice_18122025201153.pdf\",\n    \"original_filename\": \"invoice.pdf\",\n    \"file_type\": \"PDF\",\n    \"classification\": \"FACTURA\",\n    \"uploaded_at\": \"2025-12-18T20:11:53\",\n    \"processed_at\": \"2025-12-18T20:11:55\",\n    \"extracted_data\": {\n        \"cliente\": {\n            \"nombre\": \"Empresa ABC S.A. de C.V.\",\n            \"direccion\": \"Av. Principal 123, Col. Centro\",\n            \"rfc\": \"ABC123456XYZ\"\n        },\n        \"proveedor\": {\n            \"nombre\": \"Servicios Tecnol√≥gicos XYZ S.A. de C.V.\",\n            \"direccion\": \"Calle Tecnolog√≠a 456, Col. Industrial\",\n            \"rfc\": \"STX789012DEF\"\n        },\n        \"numero_factura\": \"FAC-2025-001\",\n        \"fecha\": \"2025-12-18\",\n        \"productos\": [\n            {\n                \"cantidad\": 10,\n                \"nombre\": \"Producto A\",\n                \"precio_unitario\": 100.00,\n                \"total\": 1000.00\n            }\n        ],\n        \"subtotal\": 1000.00,\n        \"iva\": 160.00,\n        \"total\": 1160.00\n    },\n    \"s3_key\": \"documents/2025/12/18/invoice_18122025201153.pdf\",\n    \"s3_bucket\": \"onecore-uploads-dev\",\n    \"file_size\": 245760\n}\n```\n\n**Ejemplo de respuesta (INFORMACI√ìN):**\n```json\n{\n    \"id\": 2,\n    \"filename\": \"info_18122025201153.pdf\",\n    \"original_filename\": \"info.pdf\",\n    \"file_type\": \"PDF\",\n    \"classification\": \"INFORMACI√ìN\",\n    \"extracted_data\": {\n        \"descripcion\": \"Documento informativo sobre...\",\n        \"resumen\": \"Resumen generado por OpenAI...\",\n        \"sentimiento\": \"positivo\"\n    },\n    \"s3_key\": \"documents/2025/12/18/info_18122025201153.pdf\",\n    \"s3_bucket\": \"onecore-uploads-dev\",\n    \"file_size\": 189234\n}\n```\n\n**Nota:**\n- Usa `{{last_document_id}}` para obtener el √∫ltimo documento subido\n- O reemplaza con un ID espec√≠fico\n- Retorna 404 si el documento no existe\n- `extracted_data` contiene todos los datos estructurados extra√≠dos"
					},
					"response": []
				}
			],
			"description": "**M√ìDULO DE DOCUMENTOS (FASE 1-3 COMPLETA)**\n\nAPIs para el m√≥dulo de an√°lisis de documentos con clasificaci√≥n y extracci√≥n autom√°tica.\n\n**APIs implementadas:**\n- ‚úÖ POST /api/v1/documents/upload - Subir documentos (PDF, JPG, PNG) con procesamiento completo\n- ‚úÖ GET /api/v1/documents - Listar documentos con filtros y datos extra√≠dos\n- ‚úÖ GET /api/v1/documents/{id} - Obtener documento por ID con datos extra√≠dos\n\n**Caracter√≠sticas FASE 1:**\n- ‚úÖ Subida a S3 y Base de Datos\n- ‚úÖ Nombres √∫nicos con timestamp (`_ddmmyyyyhhmmss`)\n- ‚úÖ Filtros y paginaci√≥n\n- ‚úÖ Registro de eventos\n\n**Caracter√≠sticas FASE 2 (Clasificaci√≥n Autom√°tica):**\n- ‚úÖ Clasificaci√≥n autom√°tica con AWS Textract (FACTURA/INFORMACI√ìN)\n- ‚úÖ Sistema de keywords con pesos para precisi√≥n\n- ‚úÖ Normalizaci√≥n de texto para mejor matching\n- ‚úÖ Logging detallado para debugging\n\n**Caracter√≠sticas FASE 3 (Extracci√≥n de Datos):**\n- ‚úÖ **Para FACTURAS:**\n  - Cliente (nombre, direcci√≥n, RFC)\n  - Proveedor (nombre, direcci√≥n, RFC)\n  - N√∫mero de factura y fecha\n  - Productos (cantidad, nombre, precio unitario, total)\n  - Totales (subtotal, IVA, total)\n- ‚úÖ **Para INFORMACI√ìN:**\n  - Descripci√≥n del contenido\n  - Resumen generado por OpenAI\n  - An√°lisis de sentimiento (positivo/negativo/neutral)\n- ‚úÖ Integraci√≥n con AWS Textract (FORMS y TABLES)\n- ‚úÖ Integraci√≥n con OpenAI (GPT-3.5-turbo)\n- ‚úÖ Datos estructurados guardados en `document_extracted_data`"
		},
		{
			"name": "5. API de Historial (FASE 4)",
			"item": [
				{
					"name": "Get History",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    pm.test(\"Historial obtenido\", function() {",
									"        pm.expect(jsonData).to.have.property(\"events\");",
									"        pm.expect(jsonData).to.have.property(\"total\");",
									"        pm.expect(jsonData.events).to.be.an(\"array\");",
									"    });",
									"    pm.test(\"Contiene paginaci√≥n\", function() {",
									"        pm.expect(jsonData).to.have.property(\"page\");",
									"        pm.expect(jsonData).to.have.property(\"page_size\");",
									"        pm.expect(jsonData).to.have.property(\"total_pages\");",
									"    });",
									"    console.log(\"‚úÖ Total de eventos: \" + jsonData.total);",
									"    console.log(\"üìÑ Eventos en esta p√°gina: \" + jsonData.events.length);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/history?page=1&page_size=50",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "history"],
							"query": [
								{"key": "page", "value": "1"},
								{"key": "page_size", "value": "50"},
								{"key": "event_type", "value": "", "disabled": true},
								{"key": "classification", "value": "", "disabled": true}
							]
						},
						"description": "**FASE 4: API DE HISTORIAL CON FILTROS AVANZADOS**\n\nListar eventos con filtros avanzados y paginaci√≥n.\n\n**Filtros disponibles:**\n- `event_type`: Tipo de evento (ej: \"Carga de documento\", \"Clasificaci√≥n\", \"Extracci√≥n\")\n- `document_id`: ID del documento\n- `user_id`: ID del usuario\n- `classification`: Clasificaci√≥n del documento (FACTURA, INFORMACI√ìN)\n- `date_from`: Fecha desde (formato datetime)\n- `date_to`: Fecha hasta (formato datetime)\n- `description_search`: B√∫squeda de texto en la descripci√≥n\n- `page`: N√∫mero de p√°gina (default: 1)\n- `page_size`: Items por p√°gina (default: 50, max: 100)\n\n**Ejemplo de respuesta:**\n```json\n{\n    \"events\": [\n        {\n            \"id\": 1,\n            \"event_type\": \"Carga de documento\",\n            \"description\": \"Documento invoice.pdf cargado exitosamente\",\n            \"document_id\": 1,\n            \"user_id\": 1,\n            \"classification\": \"FACTURA\",\n            \"created_at\": \"2025-12-18T20:11:53\"\n        }\n    ],\n    \"total\": 150,\n    \"page\": 1,\n    \"page_size\": 50,\n    \"total_pages\": 3\n}\n```\n\n**Nota:** Todos los filtros son opcionales y se pueden combinar"
					},
					"response": []
				},
				{
					"name": "Export History to Excel",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    pm.test(\"Exportaci√≥n exitosa\", function() {",
									"        pm.expect(pm.response.headers.get(\"Content-Type\")).to.include(\"spreadsheetml\");",
									"    });",
									"    console.log(\"‚úÖ Archivo Excel generado\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/v1/history/export?include_document_details=true",
							"host": ["{{base_url}}"],
							"path": ["api", "v1", "history", "export"],
							"query": [
								{"key": "include_document_details", "value": "true"}
							]
						},
						"description": "**FASE 4: EXPORTACI√ìN A EXCEL CON FILTROS**\n\nExporta historial de eventos a archivo Excel (.xlsx) con opci√≥n de aplicar filtros.\n\n**Par√°metros disponibles:**\n- `event_type`: Filtrar por tipo de evento\n- `document_id`: Filtrar por ID de documento\n- `user_id`: Filtrar por ID de usuario\n- `classification`: Filtrar por clasificaci√≥n\n- `date_from`: Filtrar desde fecha\n- `date_to`: Filtrar hasta fecha\n- `description_search`: B√∫squeda en descripci√≥n\n- `include_document_details`: Incluir detalles del documento en el Excel (default: true)\n\n**Ejemplo de uso:**\n```\nGET /api/v1/history/export?classification=FACTURA&date_from=2025-12-01T00:00:00&include_document_details=true\n```\n\n**Respuesta:**\n- Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`\n- Archivo Excel descargable con todos los eventos filtrados\n- Columnas: ID, Tipo, Descripci√≥n, Documento ID, Usuario ID, Clasificaci√≥n, Fecha\n- Si `include_document_details=true`: incluye columnas adicionales del documento\n\n**Nota:**\n- Todos los filtros son opcionales\n- El archivo se descarga autom√°ticamente en Postman\n- Los filtros se aplican igual que en el endpoint de listado"
					},
					"response": []
				}
			],
			"description": "**FASE 4: M√ìDULO HIST√ìRICO COMPLETO**\n\nAPIs para historial de eventos con filtros avanzados y exportaci√≥n.\n\n**APIs implementadas:**\n- ‚úÖ GET /api/v1/history - Listar eventos con filtros avanzados y paginaci√≥n\n- ‚úÖ GET /api/v1/history/export - Exportar historial a Excel (.xlsx)\n\n**Caracter√≠sticas:**\n- ‚úÖ Filtros avanzados: tipo, documento, usuario, clasificaci√≥n, rango de fechas, b√∫squeda en descripci√≥n\n- ‚úÖ Paginaci√≥n configurable (default: 50 items por p√°gina, max: 100)\n- ‚úÖ Exportaci√≥n a Excel con aplicaci√≥n de filtros\n- ‚úÖ Opci√≥n de incluir/excluir detalles del documento en exportaci√≥n\n- ‚úÖ Registro autom√°tico de eventos en cada operaci√≥n:\n  - Carga de documento\n  - Clasificaci√≥n autom√°tica\n  - Extracci√≥n de datos\n  - Interacciones del usuario\n\n**Tabla de eventos (`log_events`):**\n- ID del evento\n- Tipo de evento\n- Descripci√≥n del evento\n- ID del documento (si aplica)\n- ID del usuario\n- Clasificaci√≥n del documento (si aplica)\n- Fecha y hora del evento"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Pre-request script global",
					"// Verificar que base_url est√© configurado",
					"if (!pm.environment.get(\"base_url\")) {",
					"    pm.environment.set(\"base_url\", \"http://localhost:8000\");",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Test script global",
					"// Validaciones generales para todas las respuestas"
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:8000",
			"type": "string",
			"description": "URL base de la API. Por defecto: http://localhost:8000"
		},
		{
			"key": "access_token",
			"value": "",
			"type": "string",
			"description": "JWT token de autenticaci√≥n. Se actualiza autom√°ticamente al hacer login."
		},
		{
			"key": "user_id",
			"value": "",
			"type": "string",
			"description": "ID del usuario actual. Se actualiza autom√°ticamente al hacer login."
		},
		{
			"key": "user_rol",
			"value": "",
			"type": "string",
			"description": "Rol del usuario actual (admin o gestor). Se actualiza autom√°ticamente al hacer login."
		},
		{
			"key": "last_document_id",
			"value": "",
			"type": "string",
			"description": "ID del √∫ltimo documento subido. Se actualiza autom√°ticamente al subir un documento."
		}
	]
}
